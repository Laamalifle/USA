<!DOCTYPE html>
<html lang="so">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>My Orders - Laam wallet</title>
    <!-- Favicon & OG Image -->
    <link rel="icon" type="image/png" href="https://i.ibb.co/r28SP1bN/20250802-225108.png">
    <link rel="apple-touch-icon" href="https://i.ibb.co/r28SP1bN/20250802-225108.png">
    <meta property="og:image" content="https://i.ibb.co/r28SP1bN/20250802-225108.png">
    <meta property="og:title" content="My Orders - Laam wallet">
    <meta property="og:description" content="Manage your buy and sell offers on the Stellar network.">
    <meta property="og:url" content="https://laam.online">
    <meta property="og:type" content="website">
<!-- Android PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1976d2">

<!-- iPhone / iPad PWA -->
<link rel="apple-touch-icon" href="https://i.ibb.co/r28SP1bN/20250802-225108.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Laam Wallet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/stellar-sdk/10.4.0/stellar-sdk.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<style>
  :root{
    /* Blue & White Theme */
    --bg1:#eef2f3; --bg2:#8e9eab;
    --card:rgba(255, 255, 255, 0.9);
    --text:#0a192f; --muted:#546e7a;
    --brand:#0052cc; --brand2:#0041a3; --line:#d0d8e0;
    --ok:#28a745; --warn:#ffc107; --err:#dc3545;
    --maxw: 920px; --rad:16px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    color:var(--text);
    background:linear-gradient(135deg,#b8c6db,#f5f7fa);
    min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px 14px;
  }
  .app{ width:100%; max-width:600px; text-align:center; }
  
  /* Logo and Header Styles */
  .logo-container{ 
    display:flex; 
    align-items:center; 
    justify-content:center; 
    gap:15px; 
    margin-bottom:40px; 
  }
  .logo-container img{ 
    width:80px; 
    height:80px; 
    border-radius:50%;
    box-shadow:0 4px 12px rgba(0,0,0,0.1);
  }
  h1{ 
    margin:0; 
    font-size:3rem; 
    font-weight:800; 
    color:#1976d2; 
    text-shadow:1px 1px 2px rgba(0,0,0,0.1); 
  }
  
  /* Import Card Styles */
  .import-card{
    background:rgba(255, 255, 255, 0.95);
    border:none;
    border-radius:24px;
    box-shadow:0 8px 32px rgba(0,0,0,0.12);
    padding:40px 30px;
    margin:0 auto;
    backdrop-filter:blur(10px);
    max-width:100%;
  }
  
  .form-group{
    margin-bottom:24px;
    text-align:left;
  }
  
  .form-label{
    display:block;
    font-size:18px;
    font-weight:700;
    color:#1976d2;
    margin-bottom:12px;
  }
  
  .form-input{
    width:100%;
    padding:20px;
    border:2px solid #e0e0e0;
    border-radius:16px;
    font-size:16px;
    background:#f8f9fa;
    color:#333;
    outline:none;
    transition:all 0.3s ease;
    font-family:'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
  }
  
  .form-input:focus{
    border-color:#1976d2;
    background:white;
    box-shadow:0 0 0 4px rgba(25,118,210,0.1);
  }
  
  .form-input::placeholder{
    color:#bbb;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  }
  
  .import-button{
    width:100%;
    padding:20px;
    background:#1976d2;
    color:white;
    border:none;
    border-radius:16px;
    font-size:18px;
    font-weight:700;
    text-transform:uppercase;
    letter-spacing:1px;
    cursor:pointer;
    transition:all 0.3s ease;
    box-shadow:0 4px 16px rgba(25,118,210,0.3);
    margin-top:16px;
  }
  
  .import-button:hover{
    background:#1565c0;
    box-shadow:0 6px 20px rgba(25,118,210,0.4);
    transform:translateY(-2px);
  }

  /* Main Card Styles */
  .card{
    background:var(--card); border:1px solid var(--line); border-radius:var(--rad);
    box-shadow:0 10px 30px rgba(0,0,0,0.1); padding:22px; margin:14px auto;
  }
  
  /* My Orders Specific Styles */
  .orders-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--line);
  }
  
  .orders-title {
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--brand);
    margin: 0;
  }
  
  .refresh-btn {
    background: var(--brand);
    color: white;
    border: none;
    border-radius: 12px;
    padding: 12px 20px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .refresh-btn:hover {
    background: var(--brand2);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(25,118,210,0.3);
  }
  
  .orders-container {
    max-height: 400px;
    overflow-y: auto;
    margin-bottom: 20px;
  }
  
  .order-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border: 2px solid var(--line);
    border-radius: 16px;
    margin-bottom: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
    background: #f8f9fa;
  }
  
  .order-item:hover {
    background: rgba(25,118,210,0.05);
    border-color: var(--brand);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(25,118,210,0.1);
  }
  
  .order-item.selected {
    border-color: var(--brand);
    background: rgba(25,118,210,0.1);
    box-shadow: 0 4px 12px rgba(25,118,210,0.2);
  }
  
  .order-info {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }
  
  .order-type {
    font-weight: 700;
    text-transform: uppercase;
    font-size: 14px;
    padding: 4px 12px;
    border-radius: 20px;
    color: white;
  }
  
  .order-type.buy {
    background: var(--ok);
  }
  
  .order-type.sell {
    background: var(--err);
  }
  
  .order-details {
    font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
    font-size: 14px;
    color: var(--text);
  }
  
  .order-amount {
    font-weight: 600;
  }
  
  .order-price {
    color: var(--muted);
  }
  
  .order-actions {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  
  .order-action-btn {
    padding: 10px 16px;
    border: none;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 80px;
  }
  
  .edit-btn {
    background: var(--brand);
    color: white;
  }
  
  .edit-btn:hover {
    background: var(--brand2);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(25,118,210,0.3);
  }
  
  .cancel-btn {
    background: var(--err);
    color: white;
  }
  
  .cancel-btn:hover {
    background: #c82333;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(220,53,69,0.3);
  }
  
  .no-orders {
    text-align: center;
    padding: 40px 20px;
    color: var(--muted);
    font-size: 16px;
  }
  
  .loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid var(--brand);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* Modal Styles */
  .modal {
    display: none;
    position: fixed;
    inset: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }
  
  .modal.show {
    display: flex;
  }
  
  .modal-content {
    background: var(--card);
    border: 1px solid var(--line);
    border-radius: var(--rad);
    box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    padding: 30px;
    max-width: 420px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    animation: modalSlideIn 0.3s ease-out;
  }
  
  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: translateY(-50px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--line);
  }
  
  .modal-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--brand);
    margin: 0;
  }
  
  .modal-close {
    background: none;
    border: none;
    font-size: 1.8rem;
    cursor: pointer;
    color: var(--muted);
    padding: 0;
    width: auto;
    height: auto;
    box-shadow: none;
    text-transform: none;
  }
  
  .modal-close:hover {
    color: var(--text);
    transform: none;
    box-shadow: none;
  }
  
  .field {
    margin-bottom: 20px;
  }
  
  .field label {
    display: block;
    font-size: 16px;
    font-weight: 600;
    color: var(--brand);
    margin-bottom: 8px;
  }
  
  .field input {
    width: 100%;
    padding: 15px;
    border: 2px solid var(--line);
    border-radius: 12px;
    font-size: 16px;
    background: #f8f9fa;
    color: var(--text);
    outline: none;
    transition: all 0.3s ease;
    font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
  }
  
  .field input:focus {
    border-color: var(--brand);
    background: white;
    box-shadow: 0 0 0 4px rgba(25,118,210,0.1);
  }
  
  .modal-btn {
    width: 100%;
    padding: 18px;
    background: var(--brand);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 700;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 16px rgba(25,118,210,0.3);
  }
  
  .modal-btn:hover {
    background: var(--brand2);
    box-shadow: 0 6px 20px rgba(25,118,210,0.4);
    transform: translateY(-2px);
  }
  
  .modal-btn:disabled {
    background: #b0bec5;
    cursor: not-allowed;
    box-shadow: none;
    transform: none;
  }
  
  /* Back button */
  .back-btn {
    position: absolute;
    top: 20px;
    left: 20px;
    background: rgba(255,255,255,0.9);
    border: 1px solid var(--line);
    border-radius: 12px;
    padding: 12px 20px;
    color: var(--brand);
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .back-btn:hover {
    background: white;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-2px);
  }
  
  /* Responsive Design */
  @media (max-width: 640px) {
    .app {
      max-width: 100%;
      padding: 0 10px;
    }
    
    .order-item {
      flex-direction: column;
      align-items: flex-start;
      gap: 15px;
    }
    
    .order-actions {
      flex-direction: row;
      width: 100%;
      justify-content: space-between;
    }
    
    .order-action-btn {
      flex: 1;
      margin: 0 5px;
    }
    
    .orders-header {
      flex-direction: column;
      gap: 15px;
      align-items: flex-start;
    }
    
    .modal-content {
      padding: 20px;
      margin: 10px;
    }
  }
</style>
</head>
<body>
  <!-- Back button -->
  <a href="javascript:history.back()" class="back-btn">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="m12 19-7-7 7-7"/>
      <path d="M19 12H5"/>
    </svg>
    Back to Wallet
  </a>

  <div class="app">
    <div class="logo-container">
      <img src="https://i.ibb.co/r28SP1bN/20250802-225108.png" alt="Laam Logo">
      <h1>My Orders</h1>
    </div>

    <!-- AUTH SECTION -->
    <div id="authSection">
      <div class="import-card">
        <div id="unlockView" class="hidden">
          <h3 style="margin:0 0 20px 0; color:#1976d2; text-align:center; font-size:1.5rem;">Unlock Wallet</h3>
          <div class="form-group">
            <label class="form-label" for="walletPassword">Password</label>
            <input class="form-input" id="walletPassword" type="password" placeholder="Enter your password" />
          </div>
          <button class="import-button" id="unlockBtn">Unlock</button>
        </div>

        <div id="initialView">
          <div class="form-group">
            <label class="form-label" for="secretKeyInput">Secret Key (S...)</label>
            <input class="form-input" id="secretKeyInput" type="password" placeholder="SXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"/>
          </div>
          
          <button class="import-button" id="importBtn">Import Wallet</button>
        </div>
      </div>
    </div>

    <!-- MY ORDERS VIEW -->
    <div id="myOrdersView" class="hidden">
      <div class="card">
        <div class="orders-header">
          <h2 class="orders-title">My Orders</h2>
          <button class="refresh-btn" id="refreshOrdersBtn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
              <path d="M21 3v5h-5"/>
              <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
              <path d="M3 21v-5h5"/>
            </svg>
            Refresh
          </button>
        </div>
        
        <div class="orders-container" id="ordersContainer">
          <div class="no-orders">
            <div class="loading-spinner"></div>
            <p style="margin-top: 15px;">Loading your orders...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Order Modal -->
    <div id="editOrderModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Edit Order</h3>
          <button class="modal-close" onclick="closeEditModal()">&times;</button>
        </div>
        <div class="field">
          <label>Amount (Laam)</label>
          <input id="editAmount" type="number" step="0.0001" placeholder="Enter amount">
        </div>
        <div class="field">
          <label>Price (XLM per Laam)</label>
          <input id="editPrice" type="number" step="0.0000001" placeholder="Enter price">
        </div>
        <button class="modal-btn" id="confirmEditBtn">Update Order</button>
      </div>
    </div>
  </div>

  <script>
    // Laam token configuration
    const LAAM_TOKEN = {
      code: "Laam",
      issuer: "GAL4ECDAXNBMJYFCWIJ32HKVIRLCNEXY664CAZYI3EINQWPLXTMEPR64",
      name: "Laam",
      description: "Laam is a limited supply token on Stellar with a maximum of 1,335,577 tokens, issued only once to preserve value.",
      image: "https://i.ibb.co/r28SP1bN/20250802-225108.png",
      maxSupply: 1335577,
      currentPrice: 0.06
    };

    // Global variables
    let currentKeypair = null;
    let server = null;
    let LAAM_ASSET = null;
    let currentOfferId = null;
    let userOffers = [];
    
    // Initialize Stellar SDK
    function initializeStellar() {
      try {
        if (typeof StellarSdk !== 'undefined') {
          server = new StellarSdk.Server('https://horizon.stellar.org');
          LAAM_ASSET = new StellarSdk.Asset(LAAM_TOKEN.code, LAAM_TOKEN.issuer);
          console.log('Stellar SDK initialized successfully');
        } else {
          console.error('Stellar SDK not loaded');
          showError('Stellar SDK failed to load. Please refresh the page.');
        }
      } catch (error) {
        console.error('Error initializing Stellar SDK:', error);
        showError('Failed to initialize Stellar SDK: ' + error.message);
      }
    }
    
    // Utility functions
    function showError(message) {
      alert('Error: ' + message);
    }
    
    function showSuccess(message) {
      alert('Success: ' + message);
    }
    
    function formatAmount(amount) {
      return parseFloat(amount).toFixed(7);
    }
    
    function decryptSecretKey(encryptedKey, password) {
      try {
        const bytes = CryptoJS.AES.decrypt(encryptedKey, password);
        return bytes.toString(CryptoJS.enc.Utf8);
      } catch (e) {
        return null;
      }
    }

    // Check if wallet exists in localStorage
    function checkSavedWallet() {
      const encryptedKey = localStorage.getItem('laam_wallet_key');
      if (encryptedKey) {
        document.getElementById('initialView').classList.add('hidden');
        document.getElementById('unlockView').classList.remove('hidden');
      }
    }

    // Load user offers from Stellar network
    async function loadUserOffers() {
      if (!currentKeypair || !server) {
        throw new Error('Wallet not loaded or server not initialized.');
      }

      try {
        console.log('Loading user offers for:', currentKeypair.publicKey());
        
        // Get all offers for the account
        const offersResponse = await server.offers('accounts', currentKeypair.publicKey()).call();
        
        // Filter for Laam-related offers
        const laamOffers = offersResponse.records.filter(offer => {
          return (offer.selling.asset_code === LAAM_TOKEN.code && offer.selling.asset_issuer === LAAM_TOKEN.issuer) ||
                 (offer.buying.asset_code === LAAM_TOKEN.code && offer.buying.asset_issuer === LAAM_TOKEN.issuer);
        });
        
        console.log('Found', laamOffers.length, 'Laam offers');
        userOffers = laamOffers;
        return laamOffers;
        
      } catch (error) {
        console.error('Error loading user offers:', error);
        throw error;
      }
    }

    // Display user offers
    function displayOffers(offers) {
      const container = document.getElementById('ordersContainer');
      
      if (offers.length === 0) {
        container.innerHTML = `
          <div class="no-orders">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color: var(--muted); margin-bottom: 15px;">
              <path d="M9 12l2 2 4-4"/>
              <path d="M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9c2.12 0 4.07.74 5.61 1.98"/>
            </svg>
            <p>No active orders found</p>
            <p style="font-size: 14px; color: var(--muted);">Your buy and sell offers will appear here</p>
          </div>
        `;
        return;
      }
      
      let html = '';
      offers.forEach(offer => {
        const isSell = offer.selling.asset_code === LAAM_TOKEN.code;
        const orderType = isSell ? 'sell' : 'buy';
        const amount = parseFloat(offer.amount).toFixed(4);
        const price = isSell ? (1/parseFloat(offer.price)).toFixed(7) : parseFloat(offer.price).toFixed(7);
        const total = (parseFloat(amount) * parseFloat(price)).toFixed(7);
        
        html += `
          <div class="order-item" data-id="${offer.id}" onclick="selectOrder('${offer.id}')">
            <div class="order-info">
              <span class="order-type ${orderType}">${orderType.toUpperCase()}</span>
              <div class="order-details">
                <div class="order-amount">Amount: ${amount} Laam</div>
                <div class="order-price">Price: ${price} XLM</div>
                <div class="order-price">Total: ${total} XLM</div>
              </div>
            </div>
            <div class="order-actions">
              <button class="order-action-btn edit-btn" onclick="editOrder('${offer.id}'); event.stopPropagation();">Edit</button>
              <button class="order-action-btn cancel-btn" onclick="cancelOrder('${offer.id}'); event.stopPropagation();">Cancel</button>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    // Select order
    function selectOrder(offerId) {
      // Remove previous selection
      document.querySelectorAll('.order-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      // Add selection to clicked item
      const selectedItem = document.querySelector(`[data-id="${offerId}"]`);
      if (selectedItem) {
        selectedItem.classList.add('selected');
        currentOfferId = offerId;
      }
    }

    // Edit order
    async function editOrder(offerId) {
      try {
        const offer = userOffers.find(o => o.id === offerId);
        if (!offer) {
          showError('Offer not found');
          return;
        }
        
        const isSell = offer.selling.asset_code === LAAM_TOKEN.code;
        const amount = parseFloat(offer.amount);
        const price = isSell ? (1/parseFloat(offer.price)) : parseFloat(offer.price);
        
        document.getElementById('editAmount').value = amount.toFixed(4);
        document.getElementById('editPrice').value = price.toFixed(7);
        
        currentOfferId = offerId;
        document.getElementById('editOrderModal').classList.add('show');
        
      } catch (error) {
        console.error('Error editing order:', error);
        showError('Failed to load order details: ' + error.message);
      }
    }

    // Cancel order
    async function cancelOrder(offerId) {
      if (!confirm('Are you sure you want to cancel this order?')) {
        return;
      }
      
      try {
        const offer = userOffers.find(o => o.id === offerId);
        if (!offer) {
          showError('Offer not found');
          return;
        }
        
        const account = await server.loadAccount(currentKeypair.publicKey());
        
        // Create cancel operation by setting amount to 0
        const operation = StellarSdk.Operation.manageSellOffer({
          selling: offer.selling.asset_type === 'native' ? 
            StellarSdk.Asset.native() : 
            new StellarSdk.Asset(offer.selling.asset_code, offer.selling.asset_issuer),
          buying: offer.buying.asset_type === 'native' ? 
            StellarSdk.Asset.native() : 
            new StellarSdk.Asset(offer.buying.asset_code, offer.buying.asset_issuer),
          amount: '0',
          price: '1',
          offerId: offerId
        });

        const transaction = new StellarSdk.TransactionBuilder(account, {
          fee: StellarSdk.BASE_FEE,
          networkPassphrase: StellarSdk.Networks.PUBLIC
        })
        .addOperation(operation)
        .setTimeout(180)
        .build();
        
        transaction.sign(currentKeypair);
        const result = await server.submitTransaction(transaction);
        
        showSuccess('Order cancelled successfully!');
        await refreshOrders();
        
      } catch (error) {
        console.error('Error cancelling order:', error);
        showError('Failed to cancel order: ' + error.message);
      }
    }

    // Update order
    async function updateOrder(offerId, newAmount, newPrice) {
      try {
        const offer = userOffers.find(o => o.id === offerId);
        if (!offer) {
          throw new Error('Offer not found');
        }
        
        const account = await server.loadAccount(currentKeypair.publicKey());
        const isSell = offer.selling.asset_code === LAAM_TOKEN.code;
        
        let operation;
        if (isSell) {
          operation = StellarSdk.Operation.manageSellOffer({
            selling: LAAM_ASSET,
            buying: StellarSdk.Asset.native(),
            amount: newAmount.toString(),
            price: (1/newPrice).toString(), // Invert price for sell offers
            offerId: offerId
          });
        } else {
          operation = StellarSdk.Operation.manageBuyOffer({
            selling: StellarSdk.Asset.native(),
            buying: LAAM_ASSET,
            buyAmount: newAmount.toString(),
            price: newPrice.toString(),
            offerId: offerId
          });
        }

        const transaction = new StellarSdk.TransactionBuilder(account, {
          fee: StellarSdk.BASE_FEE,
          networkPassphrase: StellarSdk.Networks.PUBLIC
        })
        .addOperation(operation)
        .setTimeout(180)
        .build();
        
        transaction.sign(currentKeypair);
        const result = await server.submitTransaction(transaction);
        
        return result;
        
      } catch (error) {
        console.error('Error updating order:', error);
        throw error;
      }
    }

    // Refresh orders
    async function refreshOrders() {
      const container = document.getElementById('ordersContainer');
      container.innerHTML = `
        <div class="no-orders">
          <div class="loading-spinner"></div>
          <p style="margin-top: 15px;">Loading your orders...</p>
        </div>
      `;
      
      try {
        const offers = await loadUserOffers();
        displayOffers(offers);
      } catch (error) {
        console.error('Error refreshing orders:', error);
        container.innerHTML = `
          <div class="no-orders">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color: var(--err); margin-bottom: 15px;">
              <circle cx="12" cy="12" r="10"/>
              <line x1="15" y1="9" x2="9" y2="15"/>
              <line x1="9" y1="9" x2="15" y2="15"/>
            </svg>
            <p>Error loading orders</p>
            <p style="font-size: 14px; color: var(--muted);">${error.message}</p>
          </div>
        `;
      }
    }

    // Close edit modal
    function closeEditModal() {
      document.getElementById('editOrderModal').classList.remove('show');
      currentOfferId = null;
    }

    // Initialize the application
    async function initializeApp() {
      initializeStellar();
      checkSavedWallet();
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
      initializeApp();
      
      // Import wallet button
      document.getElementById('importBtn').addEventListener('click', async function() {
        const secretKey = document.getElementById('secretKeyInput').value.trim();
        
        if (!secretKey) {
          showError('Please enter your secret key.');
          return;
        }
        
        if (!secretKey.startsWith('S') || secretKey.length !== 56) {
          showError('Invalid secret key format. Secret key should start with S and be 56 characters long.');
          return;
        }
        
        this.textContent = 'Importing...';
        this.disabled = true;
        
        try {
          currentKeypair = StellarSdk.Keypair.fromSecret(secretKey);
          
          document.getElementById('authSection').classList.add('hidden');
          document.getElementById('myOrdersView').classList.remove('hidden');
          
          await refreshOrders();
          
        } catch (error) {
          console.error('Import error:', error);
          showError('Failed to import wallet: ' + error.message);
        } finally {
          this.textContent = 'Import Wallet';
          this.disabled = false;
        }
      });
      
      // Unlock wallet button
      document.getElementById('unlockBtn').addEventListener('click', async function() {
        const password = document.getElementById('walletPassword').value;
        const encryptedKey = localStorage.getItem('laam_wallet_key');
        
        if (!encryptedKey) {
          showError('No wallet found. Please import a wallet first.');
          return;
        }
        
        if (!password) {
          showError('Please enter your password.');
          return;
        }
        
        this.textContent = 'Unlocking...';
        this.disabled = true;
        
        try {
          const decryptedKey = decryptSecretKey(encryptedKey, password);
          
          if (!decryptedKey) {
            showError('Incorrect password.');
            return;
          }
          
          currentKeypair = StellarSdk.Keypair.fromSecret(decryptedKey);
          
          document.getElementById('authSection').classList.add('hidden');
          document.getElementById('myOrdersView').classList.remove('hidden');
          
          await refreshOrders();
          
        } catch (error) {
          console.error('Unlock error:', error);
          showError('Failed to unlock wallet: ' + error.message);
        } finally {
          this.textContent = 'Unlock';
          this.disabled = false;
        }
      });
      
      // Refresh orders button
      document.getElementById('refreshOrdersBtn').addEventListener('click', refreshOrders);
      
      // Confirm edit button
      document.getElementById('confirmEditBtn').addEventListener('click', async function() {
        const newAmount = parseFloat(document.getElementById('editAmount').value);
        const newPrice = parseFloat(document.getElementById('editPrice').value);
        
        if (!newAmount || !newPrice || newAmount <= 0 || newPrice <= 0) {
          showError('Please enter valid amount and price values.');
          return;
        }
        
        if (!currentOfferId) {
          showError('No order selected.');
          return;
        }
        
        this.disabled = true;
        this.textContent = 'Updating...';
        
        try {
          await updateOrder(currentOfferId, newAmount, newPrice);
          showSuccess('Order updated successfully!');
          closeEditModal();
          await refreshOrders();
          
        } catch (error) {
          console.error('Error updating order:', error);
          showError('Failed to update order: ' + error.message);
        } finally {
          this.disabled = false;
          this.textContent = 'Update Order';
        }
      });
    });
  </script>
</body>
</html>

